/****************************************************************
*  itemsController.js  тАФ  р╕гр╕░р╕Ър╕Ъ CRUD р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ир╕▒р╕Фр╕Бр╕▓р╕г Item
****************************************************************/
const db = require('../config/db'); // р╕Щр╕│р╣Ар╕Вр╣Йр╕▓р╣Др╕Яр╕ер╣Мр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е

/* ---------- CREATE /items (р╕кр╕гр╣Йр╕▓р╕Зр╕гр╕▓р╕вр╕Бр╕▓р╕гр╣Гр╕лр╕бр╣И) ---------- */
exports.create = async (req, res) => {
  try {
    const { title, note } = req.body; // р╕гр╕▒р╕Ър╕Др╣Ир╕▓ title р╣Бр╕ер╕░ note р╕Ир╕▓р╕Б request body
    if (!title) return res.status(400).json({ error: 'р╕Хр╣Йр╕нр╕Зр╕Бр╕гр╕нр╕Б title' }); // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡ title р╕лр╕гр╕╖р╕нр╣Др╕бр╣И

    // ЁЯФ╣ р╣Ар╕Юр╕┤р╣Ир╕бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕лр╕бр╣Ир╕ер╕Зр╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
    const [rs] = await db.query(
      'INSERT INTO items (user_id, title, note) VALUES (?,?,?)', // р╕Др╕│р╕кр╕▒р╣Ир╕З SQL р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Юр╕┤р╣Ир╕бр╕Вр╣Йр╕нр╕бр╕╣р╕е
      [req.user.id, title, note || null] // р╣Гр╕Кр╣Й user_id р╕Ир╕▓р╕Б token р╣Бр╕ер╕░ note р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕бр╕╡р╣Гр╕лр╣Йр╣Ар╕Ыр╣Зр╕Щ null
    );

    res.status(201).json({ id: rs.insertId, title, note }); // р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕ер╕▒р╕Ър╣Гр╕лр╣Й client р╣Ар╕бр╕╖р╣Ир╕нр╕кр╕│р╣Ар╕гр╣Зр╕И
  } catch (err) {
    console.error('ITEMS ERR тЖТ', err.code || err); // Log р╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф
    res.status(500).json({ error: 'DB Error' }); // р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б error р╕Цр╣Йр╕▓р╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓р╕Бр╕▒р╕Ър╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
  }
};

/* ---------- GET /items (р╕Фр╕╢р╕Зр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й) ---------- */
exports.listMine = async (req, res) => {
  try {
    // ЁЯФ╣ р╕Др╕│р╕кр╕▒р╣Ир╕З SQL р╣Ар╕Юр╕╖р╣Ир╕нр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е items р╕Вр╕нр╕З user р╕Чр╕╡р╣Ир╕ер╣Зр╕нр╕Бр╕нр╕┤р╕Щр╕нр╕вр╕╣р╣И
    const [rows] = await db.query(
      'SELECT * FROM items WHERE user_id = ? ORDER BY created_at DESC', // р╣Ар╕гр╕╡р╕вр╕Зр╕ер╕│р╕Фр╕▒р╕Ър╕Хр╕▓р╕бр╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕кр╕гр╣Йр╕▓р╕Зр╕ер╣Ир╕▓р╕кр╕╕р╕Ф
      [req.user.id] // р╣Гр╕Кр╣Й user_id р╕Ир╕▓р╕Б token
    );
    res.json(rows); // р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕ер╕▒р╕Ър╣Гр╕лр╣Й client
  } catch (err) {
    console.error('ITEMS ERR тЖТ', err); // Log р╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф
    res.status(500).json({ error: 'DB Error' }); // р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б error р╕Цр╣Йр╕▓р╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓р╕Бр╕▒р╕Ър╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
  }
};

/* ---------- GET /items/:id (р╕Фр╕╢р╕Зр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Хр╕▓р╕б ID) ---------- */
exports.getOne = async (req, res) => {
  // ЁЯФ╣ р╕Др╕│р╕кр╕▒р╣Ир╕З SQL р╣Ар╕Юр╕╖р╣Ир╕нр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Йр╕Юр╕▓р╕░р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Чр╕╡р╣Ир╕Хр╕гр╕Зр╕Бр╕▒р╕Ъ id р╣Бр╕ер╕░ user_id
  const [rows] = await db.query(
    'SELECT * FROM items WHERE id = ? AND user_id = ?', // р╕Др╣Йр╕Щр╕лр╕▓ item р╕Хр╕▓р╕б id р╣Бр╕ер╕░ user
    [req.params.id, req.user.id]
  );

  if (!rows.length) return res.status(404).json({ error: 'р╣Др╕бр╣Ир╕Юр╕Ър╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Щр╕╡р╣Й' }); // р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е
  res.json(rows[0]); // р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕ер╕▒р╕Ър╣Гр╕лр╣Й client
};

/* ---------- PUT /items/:id (р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕гр╕▓р╕вр╕Бр╕▓р╕г) ---------- */
exports.update = async (req, res) => {
  const { title, note } = req.body; // р╕гр╕▒р╕Ър╕Др╣Ир╕▓ title р╣Бр╕ер╕░ note р╕Ир╕▓р╕Б request body

  // ЁЯФ╣ р╕Др╕│р╕кр╕▒р╣Ир╕З SQL р╣Ар╕Юр╕╖р╣Ир╕нр╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Вр╣Йр╕нр╕бр╕╣р╕е
  const [result] = await db.query(
    'UPDATE items SET title = ?, note = ? WHERE id = ? AND user_id = ?', // р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х item р╕Хр╕▓р╕б id р╣Бр╕ер╕░ user
    [title, note, req.params.id, req.user.id]
  );

  if (!result.affectedRows) return res.status(404).json({ error: 'р╣Др╕бр╣Ир╕Юр╕Ър╕лр╕гр╕╖р╕нр╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣М' }); // р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕гр╕╖р╕нр╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Бр╕Бр╣Йр╣Др╕В
  res.json({ message: 'р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕│р╣Ар╕гр╣Зр╕И' }); // р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Бр╕ер╕▒р╕Ър╣Гр╕лр╣Й client р╣Ар╕бр╕╖р╣Ир╕нр╕кр╕│р╣Ар╕гр╣Зр╕И
};

/* ---------- DELETE /items/:id (р╕ер╕Ър╕гр╕▓р╕вр╕Бр╕▓р╕г) ---------- */
exports.remove = async (req, res) => {
  // ЁЯФ╣ р╕Др╕│р╕кр╕▒р╣Ир╕З SQL р╣Ар╕Юр╕╖р╣Ир╕нр╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е
  const [result] = await db.query(
    'DELETE FROM items WHERE id = ? AND user_id = ?', // р╕ер╕Ъ item р╕Хр╕▓р╕б id р╣Бр╕ер╕░ user
    [req.params.id, req.user.id]
  );

  if (!result.affectedRows) return res.status(404).json({ error: 'р╣Др╕бр╣Ир╕Юр╕Ър╕лр╕гр╕╖р╕нр╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣М' }); // р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕гр╕╖р╕нр╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕ер╕Ъ
  res.json({ message: 'р╕ер╕Ър╕кр╕│р╣Ар╕гр╣Зр╕И' }); // р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Бр╕ер╕▒р╕Ър╣Гр╕лр╣Й client р╣Ар╕бр╕╖р╣Ир╕нр╕кр╕│р╣Ар╕гр╣Зр╕И
};